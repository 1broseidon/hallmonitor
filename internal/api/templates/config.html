<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <title>Hall Monitor - Configuration</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- htmx for server-driven interactivity -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Alpine.js for client-side reactivity -->
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.13.3/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
        }

        /* Theme Styles */
        html[data-theme="dark"] {
            color-scheme: dark;
        }

        html[data-theme="dark"] body {
            background-color: #0a0a0a;
            color: #e0e0e0;
        }

        html[data-theme="light"] body {
            background-color: #f5f5f5;
            color: #222;
        }

        {{template "header-styles" .}}

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Page Header */
        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            font-size: 0.9375rem;
            opacity: 0.6;
        }

        /* Tab Navigation */
        .config-tabs {
            display: flex;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.03);
            padding: 0.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        html[data-theme="light"] .config-tabs {
            background: rgba(0, 0, 0, 0.03);
        }

        .config-tabs button {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            opacity: 0.6;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
            font-family: inherit;
        }

        .config-tabs button:hover {
            opacity: 0.9;
        }

        .config-tabs button.active {
            opacity: 1;
        }

        html[data-theme="dark"] .config-tabs button.active {
            background: rgba(255, 255, 255, 0.1);
        }

        html[data-theme="light"] .config-tabs button.active {
            background: rgba(0, 0, 0, 0.08);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .action-bar-title {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.7;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #48c78e 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: inherit;
        }

        html[data-theme="light"] .btn-secondary {
            background: rgba(0, 0, 0, 0.04);
            border-color: rgba(0, 0, 0, 0.08);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        html[data-theme="light"] .btn-secondary:hover {
            background: rgba(0, 0, 0, 0.08);
        }

        .btn-danger {
            background: rgba(241, 70, 104, 0.1);
            border: 1px solid rgba(241, 70, 104, 0.3);
            color: #f14668;
        }

        .btn-danger:hover {
            background: rgba(241, 70, 104, 0.2);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
        }

        /* Table Container */
        .table-container {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
        }

        html[data-theme="light"] .table-container {
            background: #ffffff;
            border-color: rgba(0, 0, 0, 0.08);
        }

        /* Config Table */
        .config-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .config-table thead th {
            padding: 1rem 1.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.5;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(255, 255, 255, 0.02);
            text-align: left;
        }

        html[data-theme="light"] .config-table thead th {
            border-bottom-color: rgba(0, 0, 0, 0.05);
            background: rgba(0, 0, 0, 0.02);
        }

        .config-table tbody tr {
            transition: var(--transition);
        }

        .config-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        html[data-theme="light"] .config-table tbody tr:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .config-table tbody td {
            padding: 1.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            vertical-align: middle;
        }

        html[data-theme="light"] .config-table tbody td {
            border-bottom-color: rgba(0, 0, 0, 0.03);
        }

        .monitor-name-cell {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-dot.enabled {
            background: #48c78e;
            box-shadow: 0 0 10px rgba(72, 199, 142, 0.5);
        }

        .status-dot.disabled {
            background: #888;
        }

        .monitor-primary {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .monitor-name {
            font-weight: 500;
            font-size: 1rem;
        }

        .monitor-type {
            font-size: 0.8125rem;
            opacity: 0.5;
            font-family: 'JetBrains Mono', monospace;
            text-transform: uppercase;
        }

        .monitor-target {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.5rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.05);
            color: inherit;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.875rem;
        }

        html[data-theme="light"] .action-btn {
            background: rgba(0, 0, 0, 0.05);
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        html[data-theme="light"] .action-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .action-btn.delete:hover {
            background: rgba(241, 70, 104, 0.2);
            color: #f14668;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .modal-card {
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        html[data-theme="light"] .modal-card {
            background: rgba(255, 255, 255, 0.98);
            border-color: rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        html[data-theme="light"] .modal-header {
            border-bottom-color: rgba(0, 0, 0, 0.08);
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.05);
            color: inherit;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.25rem;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            max-height: calc(85vh - 140px);
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        html[data-theme="light"] .modal-footer {
            border-top-color: rgba(0, 0, 0, 0.08);
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .form-label .required {
            color: #f14668;
            margin-left: 0.25rem;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: inherit;
            font-size: 0.9375rem;
            font-family: inherit;
            transition: var(--transition);
        }

        html[data-theme="light"] .form-input,
        html[data-theme="light"] .form-select {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.1);
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        html[data-theme="light"] .form-input:focus,
        html[data-theme="light"] .form-select:focus {
            background: rgba(0, 0, 0, 0.05);
        }

        .form-hint {
            display: block;
            font-size: 0.75rem;
            opacity: 0.5;
            margin-top: 0.25rem;
        }

        .form-error {
            display: block;
            font-size: 0.75rem;
            color: #f14668;
            margin-top: 0.25rem;
        }

        /* Toggle Switch */
        .toggle-switch {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
        }

        .toggle-switch input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            position: relative;
            transition: var(--transition);
        }

        html[data-theme="light"] .toggle-slider {
            background: rgba(0, 0, 0, 0.1);
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: var(--transition);
        }

        html[data-theme="light"] .toggle-slider::after {
            background: #333;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #667eea 0%, #48c78e 100%);
        }

        .toggle-switch input:checked + .toggle-slider::after {
            transform: translateX(20px);
            background: white;
        }

        .toggle-label {
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 5rem 2rem;
            opacity: 0.5;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .empty-state p {
            font-size: 1rem;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border: 1px solid;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideInRight 0.3s ease;
            z-index: 2000;
        }

        html[data-theme="light"] .toast {
            background: rgba(255, 255, 255, 0.98);
        }

        .toast.success {
            border-color: rgba(72, 199, 142, 0.5);
            color: #48c78e;
        }

        .toast.error {
            border-color: rgba(241, 70, 104, 0.5);
            color: #f14668;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }

            .config-tabs {
                flex-wrap: wrap;
            }

            .config-tabs button {
                flex: 1 1 calc(50% - 0.25rem);
            }

            .action-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .modal-card {
                width: 95%;
            }

            .modal-body {
                padding: 1.5rem;
            }
        }

        [x-cloak] {
            display: none !important;
        }
    </style>
</head>
<body>
    {{template "header" .}}

    <div class="main-container" x-data="configPageManager()">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Configuration</h1>
            <p class="page-subtitle">Manage monitors, groups, and server settings</p>
        </div>

        <!-- Tab Navigation -->
        <div class="config-tabs">
            <button @click="activeTab = 'monitors'" :class="{ 'active': activeTab === 'monitors' }">
                <i class="fas fa-heartbeat"></i> Monitors
            </button>
            <button @click="activeTab = 'groups'" :class="{ 'active': activeTab === 'groups' }">
                <i class="fas fa-layer-group"></i> Groups
            </button>
            <button @click="activeTab = 'server'" :class="{ 'active': activeTab === 'server' }">
                <i class="fas fa-server"></i> Server
            </button>
            <button @click="activeTab = 'storage'" :class="{ 'active': activeTab === 'storage' }">
                <i class="fas fa-database"></i> Storage
            </button>
        </div>

        <!-- Monitors Tab -->
        <div class="tab-content" :class="{ 'active': activeTab === 'monitors' }">
            <div class="action-bar">
                <div class="action-bar-title">Monitor Management</div>
                <button class="btn btn-primary" @click="openAddMonitor()">
                    <i class="fas fa-plus"></i> Add Monitor
                </button>
            </div>

            <div class="table-container">
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>Monitor</th>
                            <th>Target</th>
                            <th>Interval</th>
                            <th>Group</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-if="monitors.length === 0">
                            <tr>
                                <td colspan="6">
                                    <div class="empty-state">
                                        <i class="fas fa-heartbeat"></i>
                                        <p>No monitors configured</p>
                                    </div>
                                </td>
                            </tr>
                        </template>
                        <template x-for="monitor in monitors" :key="monitor.name">
                            <tr>
                                <td>
                                    <div class="monitor-name-cell">
                                        <span class="status-dot" :class="monitor.enabled ? 'enabled' : 'disabled'"></span>
                                        <div class="monitor-primary">
                                            <span class="monitor-name" x-text="monitor.name"></span>
                                            <span class="monitor-type" x-text="monitor.type"></span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="monitor-target" x-text="getMonitorTarget(monitor)"></span>
                                </td>
                                <td>
                                    <span x-text="formatDuration(monitor.interval)"></span>
                                </td>
                                <td>
                                    <span x-text="monitor.group"></span>
                                </td>
                                <td>
                                    <span x-text="monitor.enabled ? 'Enabled' : 'Disabled'"></span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn" @click="openEditMonitor(monitor)" title="Edit">
                                            <i class="fas fa-pen"></i>
                                        </button>
                                        <button class="action-btn delete" @click="confirmDeleteMonitor(monitor)" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Groups Tab -->
        <div class="tab-content" :class="{ 'active': activeTab === 'groups' }">
            <div class="action-bar">
                <div class="action-bar-title">Group Management</div>
                <button class="btn btn-primary" @click="openAddGroup()">
                    <i class="fas fa-plus"></i> Add Group
                </button>
            </div>

            <div class="table-container">
                <table class="config-table">
                    <thead>
                        <tr>
                            <th>Group Name</th>
                            <th>Interval</th>
                            <th>Monitors</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-if="groups.length === 0">
                            <tr>
                                <td colspan="4">
                                    <div class="empty-state">
                                        <i class="fas fa-layer-group"></i>
                                        <p>No groups configured</p>
                                    </div>
                                </td>
                            </tr>
                        </template>
                        <template x-for="group in groups" :key="group.name">
                            <tr>
                                <td>
                                    <span class="monitor-name" x-text="group.name"></span>
                                </td>
                                <td>
                                    <span x-text="formatDuration(group.interval)"></span>
                                </td>
                                <td>
                                    <span x-text="group.monitors ? group.monitors.length : 0"></span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn" @click="openEditGroup(group)" title="Edit">
                                            <i class="fas fa-pen"></i>
                                        </button>
                                        <button class="action-btn delete" @click="confirmDeleteGroup(group)" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Server Tab -->
        <div class="tab-content" :class="{ 'active': activeTab === 'server' }">
            <div class="action-bar">
                <div class="action-bar-title">Server Configuration</div>
            </div>
            <div class="empty-state" style="padding: 3rem 2rem;">
                <i class="fas fa-server"></i>
                <p>Server configuration UI coming soon</p>
                <p class="form-hint" style="margin-top: 0.5rem;">Edit config.yml directly for now</p>
            </div>
        </div>

        <!-- Storage Tab -->
        <div class="tab-content" :class="{ 'active': activeTab === 'storage' }">
            <div class="action-bar">
                <div class="action-bar-title">Storage Configuration</div>
                <button class="btn btn-primary" @click="saveStorageConfig()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>

            <div class="table-container" style="padding: 2rem;">
                <!-- Warning Banner -->
                <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 2rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i>
                        <div>
                            <strong>Important:</strong> Changing the storage backend requires a server restart to take effect.
                            <br><span class="form-hint" style="opacity: 0.7;">Your existing data will remain in the database files.</span>
                        </div>
                    </div>
                </div>

                <!-- Storage Backend Selection -->
                <div class="form-group">
                    <label class="form-label">Storage Backend</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 0.5rem;">
                        <label class="toggle-switch" style="padding: 1rem; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; cursor: pointer;" :style="storageForm.backend === 'badger' ? 'border-color: rgba(102, 126, 234, 0.5);' : ''">
                            <input type="radio" name="backend" value="badger" x-model="storageForm.backend" style="margin-right: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                    <i class="fas fa-database"></i> BadgerDB
                                </div>
                                <div class="form-hint" style="margin: 0;">Embedded local storage</div>
                            </div>
                        </label>

                        <label class="toggle-switch" style="padding: 1rem; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; cursor: pointer;" :style="storageForm.backend === 'postgres' ? 'border-color: rgba(102, 126, 234, 0.5);' : ''">
                            <input type="radio" name="backend" value="postgres" x-model="storageForm.backend" style="margin-right: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                    <i class="fas fa-server"></i> PostgreSQL
                                </div>
                                <div class="form-hint" style="margin: 0;">SQL database backend</div>
                            </div>
                        </label>

                        <label class="toggle-switch" style="padding: 1rem; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; cursor: pointer;" :style="storageForm.backend === 'influxdb' ? 'border-color: rgba(102, 126, 234, 0.5);' : ''">
                            <input type="radio" name="backend" value="influxdb" x-model="storageForm.backend" style="margin-right: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                    <i class="fas fa-wave-square"></i> InfluxDB
                                </div>
                                <div class="form-hint" style="margin: 0;">Time-series database</div>
                            </div>
                        </label>

                        <label class="toggle-switch" style="padding: 1rem; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; cursor: pointer;" :style="storageForm.backend === 'none' ? 'border-color: rgba(102, 126, 234, 0.5);' : ''">
                            <input type="radio" name="backend" value="none" x-model="storageForm.backend" style="margin-right: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">
                                    <i class="fas fa-chart-line"></i> Metrics Only
                                </div>
                                <div class="form-hint" style="margin: 0;">No persistence</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- BadgerDB Settings (shown only when backend is badger) -->
                <div x-show="storageForm.backend === 'badger'" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.08);">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">
                        <i class="fas fa-cog"></i> BadgerDB Settings
                    </h3>

                    <!-- Enabled Toggle -->
                    <div class="form-group">
                        <label class="toggle-switch">
                            <input type="checkbox" x-model="storageForm.badger.enabled">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Enable BadgerDB Storage</span>
                        </label>
                        <span class="form-hint">Turn on to persist monitor results locally</span>
                    </div>

                    <!-- Database Path -->
                    <div class="form-group">
                        <label class="form-label">Database Path</label>
                        <input type="text" class="form-input" x-model="storageForm.badger.path" placeholder="./data/hallmonitor.db">
                        <span class="form-hint">Location to store the BadgerDB database files</span>
                    </div>

                    <!-- Retention Days -->
                    <div class="form-group">
                        <label class="form-label">Retention Period (Days)</label>
                        <input type="number" class="form-input" x-model.number="storageForm.badger.retentionDays" min="1" max="365" placeholder="30">
                        <span class="form-hint">How long to keep monitor results (1-365 days)</span>
                    </div>

                    <!-- Enable Aggregation -->
                    <div class="form-group">
                        <label class="toggle-switch">
                            <input type="checkbox" x-model="storageForm.badger.enableAggregation">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Enable Data Aggregation</span>
                        </label>
                        <span class="form-hint">Pre-compute hourly and daily summaries for faster queries</span>
                    </div>
                </div>

                <!-- PostgreSQL Settings -->
                <div x-show="storageForm.backend === 'postgres'" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.08);">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">
                        <i class="fas fa-server"></i> PostgreSQL Settings
                    </h3>

                    <div class="form-group">
                        <label class="form-label">Host</label>
                        <input type="text" class="form-input" x-model="storageForm.postgres.host" placeholder="localhost">
                        <span class="form-hint">PostgreSQL server hostname or IP</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Port</label>
                        <input type="number" class="form-input" x-model.number="storageForm.postgres.port" placeholder="5432">
                        <span class="form-hint">PostgreSQL server port (default: 5432)</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Database</label>
                        <input type="text" class="form-input" x-model="storageForm.postgres.database" placeholder="hallmonitor">
                        <span class="form-hint">Database name to use</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">User</label>
                        <input type="text" class="form-input" x-model="storageForm.postgres.user" placeholder="hallmonitor">
                        <span class="form-hint">PostgreSQL username</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" x-model="storageForm.postgres.password" placeholder="Enter password">
                        <span class="form-hint">PostgreSQL password (use environment variable in production)</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">SSL Mode</label>
                        <select class="form-select" x-model="storageForm.postgres.sslmode">
                            <option value="disable">Disable</option>
                            <option value="require">Require</option>
                            <option value="verify-ca">Verify CA</option>
                            <option value="verify-full">Verify Full</option>
                        </select>
                        <span class="form-hint">SSL connection mode (use "require" for production)</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Retention Period (Days)</label>
                        <input type="number" class="form-input" x-model.number="storageForm.postgres.retentionDays" min="1" max="365" placeholder="30">
                        <span class="form-hint">How long to keep monitor results (1-365 days)</span>
                    </div>
                </div>

                <!-- InfluxDB Settings -->
                <div x-show="storageForm.backend === 'influxdb'" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.08);">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">
                        <i class="fas fa-wave-square"></i> InfluxDB Settings
                    </h3>

                    <div class="form-group">
                        <label class="form-label">URL</label>
                        <input type="url" class="form-input" x-model="storageForm.influxdb.url" placeholder="http://localhost:8086">
                        <span class="form-hint">InfluxDB server URL</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Token</label>
                        <input type="password" class="form-input" x-model="storageForm.influxdb.token" placeholder="Enter API token">
                        <span class="form-hint">InfluxDB authentication token (use environment variable in production)</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Organization</label>
                        <input type="text" class="form-input" x-model="storageForm.influxdb.org" placeholder="hallmonitor">
                        <span class="form-hint">InfluxDB organization name</span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Bucket</label>
                        <input type="text" class="form-input" x-model="storageForm.influxdb.bucket" placeholder="monitor_results">
                        <span class="form-hint">InfluxDB bucket for storing results</span>
                    </div>
                </div>

                <!-- Info panel for "none" backend -->
                <div x-show="storageForm.backend === 'none'" style="margin-top: 2rem; padding: 1.5rem; background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px;">
                    <h4 style="font-weight: 600; margin-bottom: 0.75rem;">
                        <i class="fas fa-info-circle"></i> Metrics-Only Mode
                    </h4>
                    <p style="font-size: 0.875rem; margin-bottom: 0.5rem;">
                        In this mode, HallMonitor will:
                    </p>
                    <ul style="font-size: 0.875rem; margin-left: 1.5rem; opacity: 0.9;">
                        <li>Export metrics via <code style="background: rgba(255,255,255,0.1); padding: 0.125rem 0.375rem; border-radius: 3px;">/metrics</code> endpoint</li>
                        <li>Not store historical monitor results</li>
                        <li>Disable historical queries and uptime calculations in API</li>
                        <li>Use minimal disk space (no database files)</li>
                    </ul>
                    <p class="form-hint" style="margin-top: 0.75rem;">
                        <i class="fas fa-lightbulb"></i> <strong>Tip:</strong> Use this mode when running alongside Prometheus or another time-series database.
                    </p>
                </div>
            </div>
        </div>

        <!-- Monitor Modal -->
        <div x-show="showMonitorModal" x-cloak class="modal-overlay" @click.self="showMonitorModal = false">
            <div class="modal-card" @click.stop>
                <div class="modal-header">
                    <h2 x-text="editingMonitor ? 'Edit Monitor' : 'Add Monitor'"></h2>
                    <button class="modal-close" @click="showMonitorModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveMonitor()">
                        <!-- Monitor Name -->
                        <div class="form-group">
                            <label class="form-label">Monitor Name <span class="required">*</span></label>
                            <input type="text" class="form-input" x-model="monitorForm.name"
                                   placeholder="e.g., homepage" required>
                            <span class="form-hint">Unique identifier for this monitor</span>
                        </div>

                        <!-- Monitor Type -->
                        <div class="form-group">
                            <label class="form-label">Type <span class="required">*</span></label>
                            <select class="form-select" x-model="monitorForm.type" required>
                                <option value="http">HTTP/HTTPS</option>
                                <option value="tcp">TCP</option>
                                <option value="ping">ICMP Ping</option>
                                <option value="dns">DNS</option>
                            </select>
                        </div>

                        <!-- Group Selection -->
                        <div class="form-group">
                            <label class="form-label">Group <span class="required">*</span></label>
                            <select class="form-select" x-model="monitorForm.group" required>
                                <template x-for="group in groups" :key="group.name">
                                    <option :value="group.name" x-text="group.name"></option>
                                </template>
                            </select>
                        </div>

                        <!-- URL (HTTP only) -->
                        <div class="form-group" x-show="monitorForm.type === 'http'">
                            <label class="form-label">URL <span class="required" x-show="monitorForm.type === 'http'">*</span></label>
                            <input type="url" class="form-input" x-model="monitorForm.url"
                                   placeholder="https://example.com"
                                   :required="monitorForm.type === 'http'">
                        </div>

                        <!-- Target (TCP/Ping) -->
                        <div class="form-group" x-show="monitorForm.type === 'tcp' || monitorForm.type === 'ping'">
                            <label class="form-label">Target <span class="required">*</span></label>
                            <input type="text" class="form-input" x-model="monitorForm.target"
                                   :placeholder="monitorForm.type === 'tcp' ? 'host:port' : 'hostname or IP'"
                                   :required="monitorForm.type === 'tcp' || monitorForm.type === 'ping'">
                        </div>

                        <!-- Query (DNS only) -->
                        <div class="form-group" x-show="monitorForm.type === 'dns'">
                            <label class="form-label">DNS Query <span class="required">*</span></label>
                            <input type="text" class="form-input" x-model="monitorForm.query"
                                   placeholder="example.com"
                                   :required="monitorForm.type === 'dns'">
                        </div>

                        <!-- Query Type (DNS only) -->
                        <div class="form-group" x-show="monitorForm.type === 'dns'">
                            <label class="form-label">Query Type</label>
                            <select class="form-select" x-model="monitorForm.queryType">
                                <option value="A">A</option>
                                <option value="AAAA">AAAA</option>
                                <option value="CNAME">CNAME</option>
                                <option value="MX">MX</option>
                                <option value="TXT">TXT</option>
                            </select>
                        </div>

                        <!-- Expected Status (HTTP only) -->
                        <div class="form-group" x-show="monitorForm.type === 'http'">
                            <label class="form-label">Expected Status Code</label>
                            <input type="number" class="form-input" x-model.number="monitorForm.expectedStatus"
                                   placeholder="200">
                            <span class="form-hint">Expected HTTP status code (default: 200)</span>
                        </div>

                        <!-- Interval -->
                        <div class="form-group">
                            <label class="form-label">Check Interval</label>
                            <input type="text" class="form-input" x-model="monitorForm.interval"
                                   placeholder="30s">
                            <span class="form-hint">How often to check (e.g., 30s, 1m, 5m)</span>
                        </div>

                        <!-- Timeout -->
                        <div class="form-group">
                            <label class="form-label">Timeout</label>
                            <input type="text" class="form-input" x-model="monitorForm.timeout"
                                   placeholder="10s">
                            <span class="form-hint">Maximum time to wait for response</span>
                        </div>

                        <!-- Enabled Toggle -->
                        <div class="form-group">
                            <label class="toggle-switch">
                                <input type="checkbox" x-model="monitorForm.enabled">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">Enabled</span>
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="showMonitorModal = false">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" @click="saveMonitor()">
                        <i class="fas fa-save"></i>
                        <span x-text="editingMonitor ? 'Update' : 'Create'"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Group Modal -->
        <div x-show="showGroupModal" x-cloak class="modal-overlay" @click.self="showGroupModal = false">
            <div class="modal-card" @click.stop>
                <div class="modal-header">
                    <h2 x-text="editingGroup ? 'Edit Group' : 'Add Group'"></h2>
                    <button class="modal-close" @click="showGroupModal = false">&times;</button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveGroup()">
                        <!-- Group Name -->
                        <div class="form-group">
                            <label class="form-label">Group Name <span class="required">*</span></label>
                            <input type="text" class="form-input" x-model="groupForm.name"
                                   placeholder="e.g., production" required>
                            <span class="form-hint">Unique identifier for this group</span>
                        </div>

                        <!-- Interval -->
                        <div class="form-group">
                            <label class="form-label">Default Interval</label>
                            <input type="text" class="form-input" x-model="groupForm.interval"
                                   placeholder="30s">
                            <span class="form-hint">Default check interval for monitors in this group</span>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="showGroupModal = false">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" @click="saveGroup()">
                        <i class="fas fa-save"></i>
                        <span x-text="editingGroup ? 'Update' : 'Create'"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div x-show="showToast" x-cloak class="toast" :class="toastType">
            <i class="fas" :class="toastType === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'"></i>
            <span x-text="toastMessage"></span>
        </div>
    </div>

    <script>
        // Alpine.js theme manager
        function themeManager() {
            return {
                init() {
                    const savedTheme = localStorage.getItem('hallmonitor_theme') || 'dark';
                    document.documentElement.dataset.theme = savedTheme;
                },
                toggle() {
                    const html = document.documentElement;
                    const newTheme = html.dataset.theme === 'dark' ? 'light' : 'dark';
                    html.dataset.theme = newTheme;
                    localStorage.setItem('hallmonitor_theme', newTheme);
                }
            };
        }

        // Configuration page manager
        function configPageManager() {
            return {
                activeTab: 'monitors',
                monitors: [],
                groups: [],
                showMonitorModal: false,
                showGroupModal: false,
                editingMonitor: null,
                editingGroup: null,
                showToast: false,
                toastMessage: '',
                toastType: 'success',
                monitorForm: {
                    type: 'http',
                    name: '',
                    url: '',
                    target: '',
                    query: '',
                    queryType: 'A',
                    interval: '30s',
                    timeout: '10s',
                    expectedStatus: 200,
                    enabled: true,
                    group: ''
                },
                groupForm: {
                    name: '',
                    interval: '30s',
                    monitors: []
                },
                storageForm: {
                    backend: 'badger',
                    badger: {
                        enabled: true,
                        path: './data/hallmonitor.db',
                        retentionDays: 30,
                        enableAggregation: true
                    },
                    postgres: {
                        host: 'localhost',
                        port: 5432,
                        database: 'hallmonitor',
                        user: 'hallmonitor',
                        password: '',
                        sslmode: 'disable',
                        retentionDays: 30
                    },
                    influxdb: {
                        url: 'http://localhost:8086',
                        token: '',
                        org: 'hallmonitor',
                        bucket: 'monitor_results'
                    }
                },

                async init() {
                    await this.loadData();
                },

                async loadData() {
                    try {
                        const response = await fetch('/api/v1/config');
                        const data = await response.json();

                        // Extract monitors from groups
                        this.monitors = [];
                        this.groups = data.monitoring.groups || [];

                        this.groups.forEach(group => {
                            if (group.monitors) {
                                group.monitors.forEach(monitor => {
                                    this.monitors.push({
                                        ...monitor,
                                        group: group.name,
                                        enabled: monitor.enabled === undefined || monitor.enabled === null ? true : monitor.enabled
                                    });
                                });
                            }
                        });

                        // Load storage configuration
                        if (data.storage) {
                            this.storageForm.backend = data.storage.backend || 'badger';
                            this.storageForm.badger = {
                                enabled: data.storage.badger?.enabled ?? true,
                                path: data.storage.badger?.path || './data/hallmonitor.db',
                                retentionDays: data.storage.badger?.retentionDays || 30,
                                enableAggregation: data.storage.badger?.enableAggregation ?? true
                            };
                            if (data.storage.postgres) {
                                this.storageForm.postgres = {
                                    host: data.storage.postgres.host || 'localhost',
                                    port: data.storage.postgres.port || 5432,
                                    database: data.storage.postgres.database || 'hallmonitor',
                                    user: data.storage.postgres.user || 'hallmonitor',
                                    password: data.storage.postgres.password || '',
                                    sslmode: data.storage.postgres.sslmode || 'disable',
                                    retentionDays: data.storage.postgres.retentionDays || 30
                                };
                            }
                            if (data.storage.influxdb) {
                                this.storageForm.influxdb = {
                                    url: data.storage.influxdb.url || 'http://localhost:8086',
                                    token: data.storage.influxdb.token || '',
                                    org: data.storage.influxdb.org || 'hallmonitor',
                                    bucket: data.storage.influxdb.bucket || 'monitor_results'
                                };
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load config:', error);
                        this.toast('Failed to load configuration', 'error');
                    }
                },

                getEmptyMonitorForm() {
                    return {
                        type: 'http',
                        name: '',
                        url: '',
                        target: '',
                        query: '',
                        queryType: 'A',
                        interval: '30s',
                        timeout: '10s',
                        expectedStatus: 200,
                        enabled: true,
                        group: this.groups.length > 0 ? this.groups[0].name : ''
                    };
                },

                getEmptyGroupForm() {
                    return {
                        name: '',
                        interval: '30s',
                        monitors: []
                    };
                },

                openAddMonitor() {
                    this.editingMonitor = null;
                    this.monitorForm = this.getEmptyMonitorForm();
                    this.showMonitorModal = true;
                },

                openEditMonitor(monitor) {
                    this.editingMonitor = monitor;
                    this.monitorForm = { ...monitor };
                    this.showMonitorModal = true;
                },

                async saveMonitor() {
                    try {
                        const payload = {
                            type: this.monitorForm.type,
                            name: this.monitorForm.name,
                            interval: this.monitorForm.interval || '30s',
                            timeout: this.monitorForm.timeout || '10s',
                            enabled: this.monitorForm.enabled
                        };

                        // Add type-specific fields
                        if (this.monitorForm.type === 'http') {
                            payload.url = this.monitorForm.url;
                            if (this.monitorForm.expectedStatus) {
                                payload.expectedStatus = parseInt(this.monitorForm.expectedStatus);
                            }
                        } else if (this.monitorForm.type === 'tcp' || this.monitorForm.type === 'ping') {
                            payload.target = this.monitorForm.target;
                        } else if (this.monitorForm.type === 'dns') {
                            payload.query = this.monitorForm.query;
                            payload.queryType = this.monitorForm.queryType || 'A';
                        }

                        let response;
                        if (this.editingMonitor) {
                            // Update existing monitor
                            response = await fetch(`/api/v1/monitors/${this.editingMonitor.name}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ monitor: payload })
                            });
                        } else {
                            // Create new monitor
                            response = await fetch('/api/v1/monitors', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    group_name: this.monitorForm.group,
                                    monitor: payload
                                })
                            });
                        }

                        const result = await response.json();

                        if (result.success) {
                            this.showMonitorModal = false;
                            await this.loadData();
                            this.toast(result.message, 'success');
                        } else {
                            this.toast(result.error || result.message, 'error');
                        }
                    } catch (error) {
                        console.error('Failed to save monitor:', error);
                        this.toast('Failed to save monitor', 'error');
                    }
                },

                async confirmDeleteMonitor(monitor) {
                    if (!confirm(`Delete monitor "${monitor.name}"?`)) return;

                    try {
                        const response = await fetch(`/api/v1/monitors/${monitor.name}`, {
                            method: 'DELETE'
                        });

                        const result = await response.json();

                        if (result.success) {
                            await this.loadData();
                            this.toast(result.message, 'success');
                        } else {
                            this.toast(result.error || result.message, 'error');
                        }
                    } catch (error) {
                        console.error('Failed to delete monitor:', error);
                        this.toast('Failed to delete monitor', 'error');
                    }
                },

                openAddGroup() {
                    this.editingGroup = null;
                    this.groupForm = this.getEmptyGroupForm();
                    this.showGroupModal = true;
                },

                openEditGroup(group) {
                    this.editingGroup = group;
                    this.groupForm = { ...group };
                    this.showGroupModal = true;
                },

                async saveGroup() {
                    try {
                        const payload = {
                            name: this.groupForm.name,
                            interval: this.groupForm.interval || '30s',
                            monitors: this.groupForm.monitors || []
                        };

                        let response;
                        if (this.editingGroup) {
                            // Update existing group
                            response = await fetch(`/api/v1/groups/${this.editingGroup.name}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ group: payload })
                            });
                        } else {
                            // Create new group
                            response = await fetch('/api/v1/groups', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ group: payload })
                            });
                        }

                        const result = await response.json();

                        if (result.success) {
                            this.showGroupModal = false;
                            await this.loadData();
                            this.toast(result.message, 'success');
                        } else {
                            this.toast(result.error || result.message, 'error');
                        }
                    } catch (error) {
                        console.error('Failed to save group:', error);
                        this.toast('Failed to save group', 'error');
                    }
                },

                async confirmDeleteGroup(group) {
                    if (!confirm(`Delete group "${group.name}"? This will also delete all monitors in this group.`)) return;

                    try {
                        const response = await fetch(`/api/v1/groups/${group.name}`, {
                            method: 'DELETE'
                        });

                        const result = await response.json();

                        if (result.success) {
                            await this.loadData();
                            this.toast(result.message, 'success');
                        } else {
                            this.toast(result.error || result.message, 'error');
                        }
                    } catch (error) {
                        console.error('Failed to delete group:', error);
                        this.toast('Failed to delete group', 'error');
                    }
                },

                getMonitorTarget(monitor) {
                    if (monitor.url) return monitor.url;
                    if (monitor.target) return monitor.target;
                    if (monitor.query) return monitor.query;
                    return 'N/A';
                },

                formatDuration(duration) {
                    if (!duration) return 'N/A';
                    if (typeof duration === 'string') return duration;
                    // Convert nanoseconds to human-readable format
                    const seconds = duration / 1000000000;
                    if (seconds < 60) return `${seconds}s`;
                    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
                    return `${Math.floor(seconds / 3600)}h`;
                },

                async saveStorageConfig() {
                    try {
                        // Load current full config
                        const configResponse = await fetch('/api/v1/config');
                        const currentConfig = await configResponse.json();

                        // Update storage section
                        currentConfig.storage = {
                            backend: this.storageForm.backend,
                            badger: {
                                enabled: this.storageForm.badger.enabled,
                                path: this.storageForm.badger.path,
                                retentionDays: this.storageForm.badger.retentionDays,
                                enableAggregation: this.storageForm.badger.enableAggregation
                            }
                        };

                        // Save updated config
                        const response = await fetch('/api/v1/config', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ config: currentConfig })
                        });

                        const result = await response.json();

                        if (result.success) {
                            this.toast('Storage configuration saved successfully. Restart required for changes to take effect.', 'success');
                        } else {
                            this.toast(result.error || result.message, 'error');
                        }
                    } catch (error) {
                        console.error('Failed to save storage config:', error);
                        this.toast('Failed to save storage configuration', 'error');
                    }
                },

                toast(message, type = 'success') {
                    this.toastMessage = message;
                    this.toastType = type;
                    this.showToast = true;
                    setTimeout(() => {
                        this.showToast = false;
                    }, 3000);
                }
            };
        }
    </script>
</body>
</html>
